{% extends 'base.html.twig' %}

{% block title %}Finaliser la commande{% endblock %}

{% block body %}
<div class="container">
    <h1 class="mt-5 mb-4">Finaliser la commande</h1>

    {% for message in app.flashes('success') %}
        <div class="alert alert-success" role="alert">
            {{ message }}
        </div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger" role="alert">
            {{ message }}
        </div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
        <div class="alert alert-warning" role="alert">
            {{ message }}
        </div>
    {% endfor %}

    <div class="row">
        <div class="col-md-8">
            <h2>Adresse de livraison et mode de livraison</h2>
            {{ form_start(form) }}
                <div class="mb-3">
                    {{ form_row(form.deliveryAddress) }}
                </div>
                <div class="mb-3">
                    {{ form_row(form.deliveryMethod) }}
                </div>
                {{ form_widget(form.shippingCost) }} {# Champ caché pour le coût de livraison #}
                <button type="submit" class="btn btn-primary">Confirmer la commande</button>
            {{ form_end(form) }}
        </div>
        <div class="col-md-4">
            <h2>Votre panier</h2>
            <ul class="list-group mb-3">
                {% for item in cart %}
                    <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0">{{ item.product.title }}</h6>
                            <small class="text-muted">Quantité: {{ item.quantity }}</small>
                        </div>
                        <span class="text-muted">{{ item.totalItemPrice|number_format(2, ',', ' ') }} €</span>
                    </li>
                {% endfor %}
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total (EUR)</span>
                    <strong>{{ total|number_format(2, ',', ' ') }} €</strong>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deliveryMethodRadios = document.querySelectorAll('input[name="checkout_form[deliveryMethod]"]');
            const shippingCostInput = document.getElementById('checkout_form_shippingCost');
            const totalElement = document.querySelector('#cart-total');
            const initialTotal = parseFloat('{{ total|number_format(2, '.', '') }}');

            function updateShippingCost() {
                let selectedMethod = null;
                deliveryMethodRadios.forEach(radio => {
                    if (radio.checked) {
                        selectedMethod = radio.value;
                    }
                });

                let shippingCost = 0;
                if (selectedMethod === 'standard') {
                    shippingCost = 5.00;
                } else if (selectedMethod === 'express') {
                    shippingCost = 10.00;
                }

                shippingCostInput.value = shippingCost;
                updateTotalDisplay(shippingCost);
            }

            function updateTotalDisplay(shippingCost) {
                const newTotal = initialTotal + shippingCost;
                totalElement.textContent = newTotal.toLocaleString('fr-FR', {minimumFractionDigits: 2});
            }

            deliveryMethodRadios.forEach(radio => {
                radio.addEventListener('change', updateShippingCost);
            });

            // Initialiser le coût de livraison au chargement de la page si une option est déjà sélectionnée
            updateShippingCost();
        });
    </script>
{% endblock %}